<html>
<head>
<style type="text/css">
	html,body{
		height: 100%;
		width: 100%;
		margin: 0;
		padding: 0;
	}
	#main{
		height: 100%;
		height: 100%;
	}
</style>
</head>
<body>
<div id="main">
	
</div>
<script type="text/javascript" src="../src/lib/require.min.js"></script>
<script type="text/javascript" src="../src/lib/frender.js"></script>
<script type="text/javascript">
require(['frender', 'frender/graphic/shape/Line', 'frender/custom/TaskBlock', 'frender/custom/LineTo', 'frender/container/Group', 'frender/graphic/shape/Rect'],
function (frender, Line, TaskBlock, LineTo, Group, Rect){
	var zr = frender.init(document.getElementById("main"));

	var start = new TaskBlock(zr, {
									x: 400, 
									y: 50, 
									start: true, 
									width: 50, 
									height: 50,
									style: {
										fill: '#18a689',
										text: 'Start',
										textFill: '#fff'
									}
								});
	var task = new TaskBlock(zr, {
									x: 375, 
									y: 200, 
									width: 100, 
									height: 60, 
									title: '用户任务',
									style: {
										fill: '#fff',
										text: '1fefwfwfwxgch\nkdadalj',
										textOffset: [0, 5],
										stroke: '#333'
									}
								});
	var end = new TaskBlock(zr, {
									x: 400, 
									y: 350, 
									end: true, 
									width: 50, 
									height: 50,
									style: {
										text: 'End',
										textFill: '#fff',
										fontWeight: '600',
										fill: '#cb3103',
									}
								});
	// 全局控制连线的容器
	var lineCache = {
		start: null,
		end: null,
		status: false, //判断鼠标是否按下
		context: ''//父容器
	};
	// 辅助线
	var helpLine = new Line({
		shape:{
			x1: 0,
			y1: 0,
			x2: 0,
			y2: 0
		}
	});
	zr.add(helpLine);
	// 开启连线
	new LineTo(zr, start, lineCache, helpLine).drawLine(start.getPointObj()[2], task.getPointObj()[0]);
	new LineTo(zr, task, lineCache, helpLine).drawLine(task.getPointObj()[2], end.getPointObj()[0]);
	new LineTo(zr, end, lineCache, helpLine);

	var line = new Line({
		shape: {
			x1: 100,
			y1: 0,

		}
	})
	// 离屏canvas 绘制网格

	var offsetCanvas = document.createElement('canvas');
	var height = zr.getHeight();
	var width = zr.getWidth();
	offsetCanvas.height = height;
	offsetCanvas.width = width;
	var ctx = offsetCanvas.getContext('2d');
	for(var i=15;i<height;i=i+15){
		ctx.save();
		ctx.beginPath();
		ctx.moveTo(0, i);
		ctx.lineTo(width, i);
		ctx.strokeStyle = '#999';
		ctx.stroke();
		ctx.closePath();
		ctx.restore();
	}
	for(var j=15;j<width;j=j+15){
		ctx.save();
		ctx.beginPath();
		ctx.moveTo(j, 0);
		ctx.lineTo(j, height);
		ctx.strokeStyle = '#999';
		ctx.stroke();
		ctx.closePath();
		ctx.restore();
	}
	//zr.dom.style['background'] = 'url('+offsetCanvas.toDataURL()+') center no-repeat';
	
	// 工具栏
	var group = new Group();
	//group.position = [0,0];
	var rect = new Rect({
		shape:{
			r: 0,
	        x: 0,
	        y: 0,
	        width: 100,
	        height: height
	    },
	    style:{
	    	stroke: '#000',
	    	fill: '#fff'
	    }
	})
	rect.zlevel = 101;
	var t = new Rect({
		shape: {
			r: 4,
			x: 10,
			y: 10,
			width: 80,
			height: 60
		}
	});
	t.zlevel = 101;
	group.add(rect);
	rect.on('mousemove', function(){
		this.cursor = 'default';
	})
	group.add(t);
	zr.add(group);
	var flag = false;
	var taskSub;
	t.on('mousedown', function (){
		flag = true;
	})
	zr.on('mouseup', function () {
		flag = false;
		taskSub = null;
	})
	zr.on('mousemove', function (e) {
		if(e.offsetX < 100 || !flag) return;
		if(taskSub) {
			taskSub.getRect().position[0] = e.offsetX - taskSub.getRect().shape.x - 50;
			taskSub.getRect().position[1] = e.offsetY - taskSub.getRect().shape.y - 30;
			taskSub.getRect().dirty();
			taskSub.getRect().trigger('drag');
		}else{
			taskSub = new TaskBlock(zr, {
				x: e.offsetX, 
				y: e.offsetY, 
				width: 100, 
				height: 60, 
				title: '用户任务',
				style: {
					fill: '#fff',
					text: '1fech\nkdadalj',
					textOffset: [0, 5],
					stroke: '#333'
				}
			});
			new LineTo(zr, taskSub, lineCache, helpLine);
		}
	})
})
</script>
</body>
</html>