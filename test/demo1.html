<html>
<head>
<style type="text/css">
	html,body{
		height: 100%;
		width: 100%;
		margin: 0;
		padding: 0;
	}
	#main{
		height: 100%;
		height: 100%;
	}
</style>
</head>
<body>
<div id="main">
	
</div>
<script type="text/javascript" src="../src/lib/require.js"></script>
<script type="text/javascript" src="../src/lib/zrender.js"></script>
<script type="text/javascript">
define('custom/shape/TaskBlock',[
            'zrender/graphic/shape/Polygon',
            'zrender/graphic/shape/Rect',
            'zrender/graphic/shape/Circle',
            'zrender/container/Group',
            'zrender/graphic/Text',
            'zrender/core/util'
        ], 
function (Polygon, Rect, Circle, Group, ZText, util) {
	
	function TaskBlock (zr, opt) {
		this._zr = zr;
		this._init(opt);
	}

	TaskBlock.prototype = {
		_init: function(opt) {
			var source = {
				radius: 5, // 矩形周围的线柱半径
				width: 100, // 矩形的宽
			    height: 60, // 矩形的高
			    r: 4, // 矩形的圆角半径
			    x: 100, // 矩形的起始x
			    y: 100 // 矩形的起始y
			};
			var that = this;
			if(!opt){
				opt = source;
			}else{
				util.extend(source, opt);
			}
			var group = new Group();
			var rect = new Rect({
				shape: {
		            r: source.r,
		            x: source.x,
		            y: source.y,
		            width: source.width,
		            height: source.height
		        },
		        draggable: true
			});
			var rectCaps = [];
			var rectCapsPos = function (x, y) {
				var arr = [];
				arr.push({
					x: source.x + source.width/2,
					y: source.y - source.radius - 3,
					dir: 'top'
				});
				arr.push({
					x: source.x + source.width + source.radius + 3 ,
					y: source.y + source.height/2,
					dir: 'right'
				});
				arr.push({
					x: source.x + source.width/2,
					y: source.y + source.height + source.radius + 3,
					dir: 'bottom'
				});
				arr.push({
					x: source.x - source.radius - 3,
					y: source.y + source.height/2,
					dir: 'left'
				});
				return arr;
			};
			for(var i=0,arr=rectCapsPos(source.x, source.y);i<arr.length;i++){
				var circle = new Circle({
					shape:{
						cx: arr[i].x,
			            cy: arr[i].y,
			            r: source.radius
			        }
				});
				circle.dir = arr[i].dir;
				circle.zlevel = 100;
				circle.follow = rect;
				circle.shape_cp = util.clone(circle.shape);
				group.add(circle);
				rectCaps.push(circle);
			}

			rect.on('drag', function(){
				for(var i=0;i<rectCaps.length;i++){
					var a = this.transform[4] + rectCaps[i].shape.cx;
					rectCaps[i].setShape('cx', this.transform[4] + rectCaps[i].shape_cp.cx);
					rectCaps[i].setShape('cy', this.transform[5] + rectCaps[i].shape_cp.cy);

				}
			})
			group.add(rect);
			this._zr.add(group);
			this._rectCaps = rectCaps;
			this._rect = rect;
		},
		getPointObj: function() {
			return this._rectCaps;
		},
		getRect: function() {
			return this._rect;
		}
	}
	return TaskBlock;
})

define('custom/action/lineTo', ['custom/shape/TaskBlock', 'zrender/graphic/shape/Polyline', 'zrender/core/util'], function(TaskBlock, Polyline, util) {
	return function (zr, task, lineCache, helpLine) { 
		zr.on("mouseup", function (e) {
			helpLine.setShape('x1', 0);
			helpLine.setShape('x2', 0);
			helpLine.setShape('y1', 0);
			helpLine.setShape('y2', 0);
			lineCache.status = false;
		});
		
		zr.on("mousemove", function(e) {
			if(!lineCache.status) return;
			helpLine.setShape('x2',e.offsetX);
			helpLine.setShape('y2',e.offsetY);
		});

		var points = task.getPointObj();
		/* 点的拖动 start */
		util.each(points, function(point) {
			point.on("mousedown", function(e) {
				lineCache.start = point;
				lineCache.status = true;
				lineCache.context = task;
				helpLine.setShape('x1', point.shape.cx);
				helpLine.setShape('x2', point.shape.cx);
				helpLine.setShape('y1', point.shape.cy);
				helpLine.setShape('y2', point.shape.cy);
			})
			
			point.on("mouseup", function(e) {
				if(lineCache.status && lineCache.context != task) {				
					lineCache.end = point;
					drawLine(lineCache.start, lineCache.end);
				}
				helpLine.setShape('x1', 0);
				helpLine.setShape('x2', 0);
				helpLine.setShape('y1', 0);
				helpLine.setShape('y2', 0);
			})
		})
		function drawLine (start, end) {
			var pline = new Polyline({
				shape: {
					points: [[start.shape.cx + start.position[0], start.shape.cy + start.position[1]], [end.shape.cx + end.position[0], end.shape.cy + end.position[1]]],
				}
			})
			start.follow.on('drag', function(){
				var x1 = start.position[0] + start.shape.cx;
				var y1 = start.position[1] + start.shape.cy;
				var points = pline.shape.points;
				points[0] = [x1, y1];
				pline.setShape('points', points);
			})
			end.follow.on('drag', function(){
				var x1 = end.position[0] + end.shape.cx;
				var y1 = end.position[1] + end.shape.cy;
				var points = pline.shape.points;
				points[1] = [x1, y1];
				pline.setShape('points', points);
			})
			zr.add(pline);
		}
		/* 点的拖动 end */
	}
})
require(['zrender', 'zrender/graphic/shape/Line', 'custom/shape/TaskBlock', 'custom/action/lineTo'],
function (zrender, Line, TaskBlock, lineTo){
	var zr = zrender.init(document.getElementById("main"));
	
	var task1 = new TaskBlock(zr, {x: 100, y: 100});
	var task2 = new TaskBlock(zr, {x: 300, y: 100});
	var task3 = new TaskBlock(zr, {x: 700, y: 120});
	// 全局控制连线的容器
	var lineCache = {
		start: null,
		end: null,
		status: false, //判断鼠标是否按下
		context: ''//父容器
	};
	// 辅助线
	var helpLine = new Line({
		shape:{
			x1: 0,
			y1: 0,
			x2: 0,
			y2: 0
		}
	});
	zr.add(helpLine);
	// 开启连线
	lineTo(zr, task1, lineCache, helpLine);
	lineTo(zr, task2, lineCache, helpLine);
	lineTo(zr, task3, lineCache, helpLine);
})
</script>
</body>
</html>